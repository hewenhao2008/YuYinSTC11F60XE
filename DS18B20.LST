C51 COMPILER V9.01   DS18B20                                                               08/30/2013 17:16:58 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN DS18B20.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE DS18B20.c OPTIMIZE(9,SPEED) BROWSE INCDIR(C:\Keil\C51\INC) DEBUG OBJECTEXTE
                    -ND TABS(2)

line level    source

   1          #include "STC11F60XE.h"
   2          #include "intrins.h"
   3          #include "ds18b20.h"
   4          sbit DQ = P0 ^ 2;//DS18B20数据引脚
   5          extern void U1_send(unsigned char i);
   6          void Delayus(int num)   //@22.1184MHz
   7          {
   8   1        num*=4;
   9   1        while(num--);
  10   1      }
  11          
  12          void Delay15us()    //@22.1184MHz
  13          {
  14   1        unsigned char i;
  15   1      
  16   1        i = 80;
  17   1        while (--i);
  18   1      }
  19          
  20          void Delay45us()    //@22.1184MHz
  21          {
  22   1        unsigned char i, j;
  23   1      
  24   1        _nop_();
  25   1        i = 1;
  26   1        j = 244;
  27   1        do
  28   1        {
  29   2          while (--j);
  30   2        } while (--i);
  31   1      }
  32          
  33          void Init_DS18B20()
  34          {
  35   1        DQ = 1;
  36   1        Delayus(10);
  37   1        DQ = 0;
  38   1        Delayus(510);
  39   1        DQ = 1;
  40   1        Delayus(30);
  41   1      #if 1 
  42   1        if(DQ)
  43   1        {
  44   2          U1_send('1');
  45   2          Delayus(30);
  46   2        }
  47   1      #endif  
  48   1        Delayus(510);
  49   1        DQ = 1; 
  50   1      }
  51          
  52          unsigned char ReadOneChar()
  53          {
  54   1        unsigned char i,dat=0;
C51 COMPILER V9.01   DS18B20                                                               08/30/2013 17:16:58 PAGE 2   

  55   1        for(i = 0;i < 8;i++)
  56   1        {
  57   2          dat >>= 1;  
  58   2          DQ = 1;
  59   2          _nop_();
  60   2          _nop_();    
  61   2          DQ = 0;
  62   2          _nop_();
  63   2          _nop_();
  64   2          _nop_();  
  65   2          DQ = 1;
  66   2          _nop_();
  67   2          _nop_();
  68   2          _nop_();    
  69   2          _nop_();
  70   2          _nop_();    
  71   2          if(DQ)
  72   2            dat |= 0x80;
  73   2          Delayus(35);
  74   2        }
  75   1        DQ = 1;
  76   1        Delayus(35);
  77   1        return dat;
  78   1      }
  79          
  80          void WriteOneChar(unsigned char dat)
  81          {
  82   1        unsigned char i;
  83   1        for(i = 0;i < 8;i++)
  84   1        {
  85   2          DQ = 0;
  86   2          Delay15us();
  87   2          DQ = dat&0x01;
  88   2          dat >>= 1;
  89   2          Delay45us();
  90   2          DQ = 1;
  91   2        } 
  92   1        DQ = 1;
  93   1        Delayus(65);
  94   1      }
  95          
  96          
  97          int GetTemperature(void)
  98          {
  99   1        unsigned char a=0;
 100   1        unsigned char b=0;
 101   1        int Temperature;
 102   1        int tmp = 0;
 103   1      
 104   1        Init_DS18B20();
 105   1        WriteOneChar(0xCC); // 跳过读序号列号的操作
 106   1        WriteOneChar(0x44); // 启动温度转换
 107   1        Delayus(510);
 108   1        Init_DS18B20();
 109   1        WriteOneChar(0xCC); //跳过读序号列号的操作 
 110   1        WriteOneChar(0xBE); //读取温度寄存器等（共可读9个寄存器） 前两个就是温度
 111   1        a=ReadOneChar();
 112   1        b=ReadOneChar();
 113   1        
 114   1        //U1_send(b);
 115   1        //U1_send(a);
 116   1        //U1_send(' ');
C51 COMPILER V9.01   DS18B20                                                               08/30/2013 17:16:58 PAGE 3   

 117   1          
 118   1        tmp = b;
 119   1        tmp<<=8;
 120   1        tmp |= a; //组合温度
 121   1        
 122   1        Temperature = (tmp&(~0xF800))*0.0625; 
 123   1        return (tmp&0xF800)?-Temperature:Temperature;
 124   1      }
 125          
 126          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    273    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
